<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文秘工作AI智能小助理</title>
    <link rel="icon" type="image/svg+xml" href="./icon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --chat-bg: #f9fafb;
            --sidebar-bg: #f9fafb;
            --mini-sidebar-bg: #f9fafb;
            --user-msg-bg: #dbeafe; /* A lighter blue for user messages */
            --ai-msg-bg: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --accent-color: #ef4444;
        }
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
            background-color: var(--chat-bg);
            color: var(--text-primary);
        }
        #sidebar { 
            background-color: var(--sidebar-bg);
            transition: transform 0.3s ease-in-out;
        }
        #mini-sidebar {
            background-color: var(--mini-sidebar-bg);
        }
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 3px; }
        
        /* Chat Bubble Styling */
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            max-width: 90%; /* Max width for long messages */
            width: -moz-fit-content;
            width: fit-content; /* Make bubble wrap content */
            word-wrap: break-word; /* Break long words */
        }
        .user-message {
            background-color: var(--user-msg-bg);
            align-self: flex-end;
        }
        .ai-message {
            background-color: var(--ai-msg-bg);
            align-self: flex-start;
            border: 1px solid #e5e7eb;
        }

        .loading-dots span {
            display: inline-block; width: 8px; height: 8px; background-color: var(--text-secondary); border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border: 1px solid #e5e7eb; }
        .calendar-day { background-color: white; padding: 0.5rem; min-height: 80px; cursor: pointer; transition: background-color 0.2s; position: relative; }
        .calendar-day:hover, .calendar-day.selected { background-color: #fef2f2; border: 1px solid var(--accent-color); }
        .calendar-day .day-number { font-size: 0.875rem; }
        .calendar-day.has-event .day-number::after { content: ''; display: block; width: 6px; height: 6px; background-color: var(--accent-color); border-radius: 50%; margin: 2px auto 0; }
        .sidebar a.active {
            background-color: #e5e7eb;
        }
        #contextMenu {
            transition: opacity 0.1s ease;
        }
        #collapseHistoryBtn svg {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <div class="flex h-full">
        <!-- Mini Sidebar -->
        <div id="mini-sidebar" class="w-16 flex-shrink-0 flex flex-col items-center py-4 space-y-6 border-r border-gray-200">
            <div class="mb-2">
                <img src="./icon.svg" alt="AI助手" class="w-10 h-10">
            </div>
            <button id="sidebarToggleBtn" title="展开/折叠菜单" class="p-2 rounded-md text-gray-600 hover:text-gray-800 hover:bg-gray-200">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <button id="newChatBtn" title="发起新对话" class="p-2 rounded-md text-gray-600 hover:text-gray-800 hover:bg-gray-200">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" />
                </svg>
            </button>
        </div>
        
        <!-- Main Sidebar -->
        <aside id="sidebar" class="w-64 text-gray-800 flex-col flex-shrink-0 flex border-r border-gray-200">
             <div class="p-4 border-b border-gray-200 flex items-center justify-center space-x-2">
                <img src="./icon.svg" alt="AI助手" class="w-8 h-8">
                <h1 class="text-lg font-semibold">文秘AI助理</h1>
            </div>
            <div class="flex-1 p-2 space-y-1 overflow-y-auto">
                 <div class="flex justify-between items-center px-1 py-1 text-xs text-gray-500">
                    <span class="font-semibold">最近对话</span>
                    <button id="collapseHistoryBtn" class="p-1 rounded-full hover:bg-gray-200">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                </div>
                <nav id="chatHistoryList" class="space-y-1">
                    <!-- Chat history will be populated here -->
                </nav>
            </div>
            <div class="p-2 border-t border-gray-200 space-y-1">
                 <a href="#" id="calendarButton" class="flex items-center px-3 py-2 text-sm rounded-md hover:bg-gray-200">
                    <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    工作日历
                </a>
                 <a href="#" id="clearHistory" class="flex items-center px-3 py-2 text-sm rounded-md hover:bg-gray-200">
                    <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    清除所有对话
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-gray-50 relative">
            <!-- Centered Content Wrapper -->
            <div class="w-full h-full flex flex-col max-w-4xl mx-auto">
                <!-- Chat Area -->
                <div id="chatHistory" class="chat-container flex-1 p-6 overflow-y-auto flex flex-col space-y-4">
                    <div class="flex flex-col space-y-6 h-full justify-center items-center" id="welcomeScreen">
                        <div class="w-16 h-16 bg-red-600 text-white flex items-center justify-center rounded-full text-3xl font-bold">
                            文
                        </div>
                        <h2 class="text-2xl font-semibold">文秘工作AI智能小助理</h2>
                        <p class="text-gray-500">请选择一个模式开始对话</p>
                        <div id="modeSelection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 w-full">
                            <button class="p-4 border rounded-lg hover:bg-gray-100 text-left" onclick="setMode('qa')">
                                <h3 class="font-semibold">智能问答</h3>
                                <p class="text-sm text-gray-500">解答办公、会议等问题</p>
                            </button>
                            <button class="p-4 border rounded-lg hover:bg-gray-100 text-left" onclick="setMode('material')">
                                <h3 class="font-semibold">材料生成</h3>
                                <p class="text-sm text-gray-500">撰写公文、报告、总结</p>
                            </button>
                             <button class="p-4 border rounded-lg hover:bg-gray-100 text-left" onclick="setMode('correct')">
                                <h3 class="font-semibold">智能纠错</h3>
                                <p class="text-sm text-gray-500">校对错别字、语法、格式</p>
                            </button>
                            <button class="p-4 border rounded-lg hover:bg-gray-100 text-left" onclick="setMode('reminder')">
                                <h3 class="font-semibold">⏰ 智能提醒</h3>
                                <p class="text-sm text-gray-500">固定格式：今天/明天 HH:MM 内容 或 MM-DD HH:MM 内容</p>
                            </button>
                        </div>
                    </div>
                    <!-- Chat messages will be appended here -->
                </div>

                <!-- Mode Info Bar -->
                <div class="px-4 py-2 bg-white border-t border-gray-200" id="modeInfoBar" style="display: none;">
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span class="flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            当前模式: <span class="font-medium text-gray-700 ml-1" id="currentModeDisplay">未选择</span>
                        </span>
                        <span class="text-gray-400" id="modeDescription"></span>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 bg-gray-50/90 backdrop-blur-sm sticky bottom-0">
                    <div class="relative flex items-center">
                        <textarea id="userInput" placeholder="你好，请问有什么可以帮您？" class="w-full p-3 pr-20 rounded-lg border-2 border-gray-200 focus:border-red-500 focus:outline-none resize-none" rows="1" oninput="this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'"></textarea>
                        <button id="askButton" class="absolute right-3 top-1/2 -translate-y-1/2 bg-red-600 text-white rounded-lg p-2 disabled:bg-gray-400 hover:bg-red-700 transition-colors">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Calendar Modal -->
    <div id="calendarModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCalendar()">&times;</span>
            <h2 class="text-xl font-bold mb-4">工作日历</h2>
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Calendar Grid -->
                <div class="flex-1">
                     <div class="flex items-center justify-between mb-2">
                        <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-200">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <h3 id="calendarHeader" class="text-lg font-semibold"></h3>
                        <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-200">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                     </div>
                     <div id="calendar" class="calendar-grid">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>
                <!-- Events & Add Form -->
                <div class="w-full md:w-1/3">
                    <h3 class="font-semibold mb-2">添加新事件</h3>
                    <div class="flex flex-col gap-2 mb-4">
                        <input type="date" id="modalEventDate" class="border rounded px-3 py-2 bg-gray-100">
                        <input type="time" id="modalEventTime" class="border rounded px-3 py-2">
                        <input type="text" id="modalEventText" placeholder="输入事件内容..." class="border rounded px-3 py-2 flex-1">
                        <button onclick="addModalEvent()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">添加事件</button>
                    </div>
                    <hr class="my-4">
                    <h3 class="font-semibold mb-2">事件列表</h3>
                    <div id="modalEventsList" class="max-h-60 overflow-y-auto">
                        <!-- Events will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Context Menu -->
    <div id="contextMenu" class="hidden absolute z-50 bg-white shadow-lg rounded-md py-1 w-28">
        <button onclick="deleteMessageHandler()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">删除</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_KEY = 'sk-kyuhswemmhnjlftcwwbdxoudivvxiqhfackqaxrrkwrmllyl';
        const API_URL = 'https://api.siliconflow.cn/v1/chat/completions';
        let MODEL_NAME = 'Qwen/Qwen3-8B';
        
        // Available models
        const AVAILABLE_MODELS = [
            'Qwen/Qwen2.5-7B-Instruct',
            'Qwen/Qwen2.5-14B-Instruct',
            'Qwen/Qwen2.5-32B-Instruct',
            'deepseek-ai/DeepSeek-V2.5',
            'meta-llama/Meta-Llama-3.1-8B-Instruct',
            'meta-llama/Meta-Llama-3.1-70B-Instruct'
        ];

        // --- GLOBAL STATE ---
        let sessions = [];
        let activeSessionId = null;
        let currentNewChatMode = null;
        let isLoading = false;
        let currentCalendarDate = new Date();

        // --- DOM ELEMENTS ---
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const chatHistoryContainer = document.getElementById('chatHistory');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const userInput = document.getElementById('userInput');
        const askButton = document.getElementById('askButton');
        const chatHistoryList = document.getElementById('chatHistoryList');
        const newChatBtn = document.getElementById('newChatBtn');
        const clearHistoryBtn = document.getElementById('clearHistory');
        const calendarButton = document.getElementById('calendarButton');
        const collapseHistoryBtn = document.getElementById('collapseHistoryBtn');
        const contextMenu = document.getElementById('contextMenu');

        // --- CORE FUNCTIONS ---
        function saveSessions() {
            localStorage.setItem('secretaryAiSessions', JSON.stringify(sessions));
        }

        function loadSessions() {
            sessions = JSON.parse(localStorage.getItem('secretaryAiSessions') || '[]');
        }

        function renderChatList() {
            if (!chatHistoryList) return;
            chatHistoryList.innerHTML = '';
            sessions.forEach(session => {
                const a = document.createElement('a');
                a.href = '#';
                a.className = 'flex flex-col px-3 py-2 text-sm rounded-md hover:bg-gray-200';
                if (session.id === activeSessionId) {
                    a.classList.add('active');
                }
                
                // Create title element
                const titleDiv = document.createElement('div');
                titleDiv.className = 'truncate font-medium';
                titleDiv.textContent = session.title || '新对话';
                a.appendChild(titleDiv);
                
                // Create mode info element
                if (session.mode) {
                    const modeNames = {
                        'qa': '智能问答',
                        'material': '材料生成',
                        'correct': '智能纠错'
                    };
                    const modeDiv = document.createElement('div');
                    modeDiv.className = 'text-xs text-gray-500 truncate';
                    modeDiv.textContent = modeNames[session.mode] || session.mode;
                    a.appendChild(modeDiv);
                }
                
                a.onclick = (e) => {
                    e.preventDefault();
                    loadChat(session.id);
                };
                chatHistoryList.prepend(a);
            });
        }

        function showNewChatScreen() {
            activeSessionId = null;
            currentNewChatMode = null;
            chatHistoryContainer.innerHTML = '';
            chatHistoryContainer.appendChild(welcomeScreen);
            welcomeScreen.style.display = 'flex';
            userInput.placeholder = "请先选择一个模式...";
            document.querySelectorAll('#modeSelection button').forEach(btn => btn.classList.remove('bg-red-100', 'border-red-500'));
            
            // Hide mode info bar
            const modeInfoBar = document.getElementById('modeInfoBar');
            if (modeInfoBar) {
                modeInfoBar.style.display = 'none';
            }
            
            renderChatList();
        }
        
        function setMode(mode) {
            currentNewChatMode = mode;
            const modeButtons = document.querySelectorAll('#modeSelection button');
            modeButtons.forEach(btn => btn.classList.remove('bg-red-100', 'border-red-500'));
            const selectedBtn = Array.from(modeButtons).find(btn => btn.getAttribute('onclick').includes(`'${mode}'`));
            if (selectedBtn) {
                selectedBtn.classList.add('bg-red-100', 'border-red-500');
            }
            
            // Update mode info bar
            const modeInfoBar = document.getElementById('modeInfoBar');
            const currentModeDisplay = document.getElementById('currentModeDisplay');
            const modeDescription = document.getElementById('modeDescription');
            
            if (selectedBtn && modeInfoBar && currentModeDisplay && modeDescription) {
                const modeName = selectedBtn.querySelector('h3').textContent;
                const modeDesc = selectedBtn.querySelector('p').textContent;
                
                currentModeDisplay.textContent = modeName;
                modeDescription.textContent = modeDesc;
                modeInfoBar.style.display = 'block';
            }
            
            // 智能提醒模式特殊处理
            if (mode === 'reminder') {
                // 显示通知权限状态
                const permissionStatus = Notification.permission;
                let statusMessage = '';
                let statusColor = '';
                
                if (permissionStatus === 'granted') {
                    statusMessage = '✅ 通知权限已授权';
                    statusColor = 'text-green-600';
                } else if (permissionStatus === 'denied') {
                    statusMessage = '❌ 通知权限被拒绝，请在浏览器设置中允许通知';
                    statusColor = 'text-red-600';
                } else {
                    statusMessage = '⚠️ 通知权限待授权，将在创建提醒时请求';
                    statusColor = 'text-yellow-600';
                }
                
                // 在模式描述下方添加权限状态
                if (modeDescription) {
                    modeDescription.innerHTML = `设置日程提醒和通知<br><span class="${statusColor} text-sm">${statusMessage}</span>`;
                }
            }
            
            userInput.focus();
            userInput.placeholder = `已选择${selectedBtn.querySelector('h3').textContent}模式，开始提问...`;
        }

        function loadChat(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            activeSessionId = sessionId;
            welcomeScreen.style.display = 'none';
            chatHistoryContainer.innerHTML = '';
            session.messages.forEach(msg => {
                addMessageToChat(msg.content, msg.role === 'user', msg.id);
            });
            
            // Update mode info bar for existing session
            const modeInfoBar = document.getElementById('modeInfoBar');
            const currentModeDisplay = document.getElementById('currentModeDisplay');
            const modeDescription = document.getElementById('modeDescription');
            
            if (session.mode && modeInfoBar && currentModeDisplay && modeDescription) {
                const modeNames = {
                    'qa': { name: '智能问答', desc: '解答办公、会议等问题' },
                    'material': { name: '材料生成', desc: '撰写公文、报告、总结' },
                    'correct': { name: '智能纠错', desc: '校对错别字、语法、格式' },
                    'reminder': { name: '⏰ 智能提醒', desc: '固定格式输入：今天/明天/后天 HH:MM 内容 | MM-DD HH:MM 内容 | YYYY-MM-DD HH:MM 内容' }
                };
                
                const modeInfo = modeNames[session.mode];
                if (modeInfo) {
                    currentModeDisplay.textContent = modeInfo.name;
                    modeDescription.textContent = modeInfo.desc;
                    modeInfoBar.style.display = 'block';
                }
            }
            
            renderChatList();
        }

        function addMessageToChat(content, isUser, messageId, useTypewriter = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user-message' : 'ai-message'}`;
            messageDiv.dataset.messageId = messageId;
            
            if (isUser || !useTypewriter) {
                const parsedContent = isUser ? content.replace(/\n/g, '<br>') : marked.parse(content);
                messageDiv.innerHTML = `<div>${parsedContent}</div>`;
                chatHistoryContainer.appendChild(messageDiv);
                chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
            } else {
                // AI message with typewriter effect
                const contentDiv = document.createElement('div');
                messageDiv.appendChild(contentDiv);
                chatHistoryContainer.appendChild(messageDiv);
                
                // Start typewriter effect
                typewriterEffect(contentDiv, content);
            }
        }
        
        function typewriterEffect(element, text, speed = 30) {
            let index = 0;
            let currentText = '';
            
            function typeNextChar() {
                if (index < text.length) {
                    currentText += text[index];
                    // Parse markdown for each update to maintain formatting
                    element.innerHTML = marked.parse(currentText);
                    index++;
                    
                    // Auto-scroll to bottom
                    chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
                    
                    setTimeout(typeNextChar, speed);
                }
            }
            
            typeNextChar();
        }

        async function sendMessage() {
            if (isLoading) return;
            const message = userInput.value.trim();
            if (!message) return;

            if (!activeSessionId && !currentNewChatMode) {
                const alertModal = document.createElement('div');
                alertModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                alertModal.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-xl"><p>请先选择一个对话模式！</p><button onclick="this.parentElement.parentElement.remove()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded">好的</button></div>`;
                document.body.appendChild(alertModal);
                return;
            }

            userInput.value = '';
            userInput.style.height = 'auto';
            welcomeScreen.style.display = 'none';
            
            let currentSession;
            const userMessage = { role: 'user', content: message, id: Date.now() };

            if (!activeSessionId) {
                const newSessionId = Date.now().toString();
                currentSession = {
                    id: newSessionId,
                    title: message.substring(0, 30),
                    mode: currentNewChatMode,
                    messages: [userMessage]
                };
                sessions.push(currentSession);
                activeSessionId = newSessionId;
                renderChatList();
            } else {
                currentSession = sessions.find(s => s.id === activeSessionId);
                currentSession.messages.push(userMessage);
            }

            addMessageToChat(userMessage.content, true, userMessage.id);
            saveSessions();
            
            isLoading = true;
            askButton.disabled = true;

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message ai-message';
            loadingDiv.innerHTML = `<div class="loading-dots"><span></span><span></span><span></span></div>`;
            chatHistoryContainer.appendChild(loadingDiv);
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;

            try {
                let systemPrompt = '';
                switch (currentSession.mode) {
                    case 'qa': 
                        systemPrompt = `你是一个专业的文秘工作智能助理，专门负责解答办公、会议、行政管理等相关问题。

你的职责包括：
1. 解答办公流程、制度规范、工作安排等问题
2. 提供会议组织、接待礼仪、公文处理等专业建议
3. 协助解决日常行政事务和工作协调问题
4. 提供时间管理、效率提升等工作方法指导

回答要求：
- 准确专业，基于文秘工作实践
- 条理清晰，便于理解和执行
- 提供具体可操作的建议
- 语言正式但亲和，符合办公环境`;
                        break;
                    case 'material': 
                        systemPrompt = `你是一个专业的文秘材料生成助理，擅长撰写各类公文、报告、总结等办公文档。

你的专长包括：
1. 公文写作：通知、通报、请示、报告、函件等
2. 工作总结：月度、季度、年度工作总结
3. 计划方案：工作计划、活动方案、实施细则
4. 会议文档：会议纪要、发言稿、汇报材料
5. 其他文档：制度规范、操作手册、宣传材料

写作要求：
- 格式规范，符合公文标准
- 内容充实，逻辑清晰
- 语言准确，表达得体
- 结构完整，要素齐全
- 根据具体需求调整文风和详细程度`;
                        break;
                    case 'correct': 
                        systemPrompt = `你是一个专业的文档校对助理，专门负责检查和纠正各类文档中的错误。

你的校对范围：
1. 错别字检查：识别并纠正错误的汉字
2. 语法错误：修正语法结构、句式问题
3. 标点符号：规范标点使用，确保准确性
4. 格式规范：检查文档格式、排版问题
5. 逻辑表达：优化语言表达，提升文档质量
6. 专业术语：确保专业词汇使用准确

校对原则：
- 保持原文意思不变
- 提供具体的修改建议
- 说明修改理由
- 标注修改位置
- 区分错误类型（错别字/语法/格式等）
- 提供修改前后对比`;
                        break;
                    case 'reminder':
                        systemPrompt = `你是一个简洁高效的闹钟提醒助理。

**固定格式说明：**
请使用以下标准格式设置提醒：
格式：日期 时间 提醒内容

**支持的日期格式：**
- 今天、明天、后天
- MM-DD（如：01-15）
- YYYY-MM-DD（如：2025-01-15）

**时间格式（24小时制）：**
- HH:MM（如：09:30、14:00、20:15）

**示例：**
- "明天 09:30 开会"
- "01-15 14:00 项目汇报"
- "2025-02-01 10:00 年会准备"

**回复要求：**
- 如果格式正确，直接确认并创建提醒
- 如果格式错误，提供正确格式示例
- 保持回复简洁，避免冗长解释
- 不要进行复杂的自然语言解析

请严格按照上述格式处理用户输入。`;
                        break;
                    default: 
                        systemPrompt = `你是一个专业的文秘工作智能助理，能够协助处理各类办公事务。

主要功能：
1. 智能问答：解答办公、会议、行政管理问题
2. 材料生成：撰写公文、报告、总结等文档
3. 智能纠错：校对文档错误，优化表达
4. 智能提醒：设置日程提醒和通知

工作原则：
- 专业准确，服务高效
- 格式规范，内容充实
- 语言得体，表达清晰`;
                }

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [{ role: 'system', content: systemPrompt }, ...currentSession.messages.slice(-10).map(m => ({role: m.role, content: m.content}))], // API doesn't need ID
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                let aiResponseContent = data.choices[0].message.content;
                
                // 智能提醒模式特殊处理
                if (currentSession.mode === 'reminder') {
                    const parsed = SimpleTimeParser.parseFixedFormat(userMessage.content);
                    const notificationPermission = Notification.permission;
                    
                    if (parsed.isValid) {
                        try {
                            const reminder = ReminderManager.createReminder(parsed.content, parsed.dateTime);
                            const dateStr = parsed.dateTime.toLocaleDateString('zh-CN');
                            const timeStr = parsed.dateTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                            const now = new Date();
                            const delay = Math.round((parsed.dateTime - now) / 1000 / 60); // 分钟
                            
                            let notificationStatus = '';
                            if (notificationPermission === 'granted') {
                                notificationStatus = '✅ 通知已授权';
                            } else if (notificationPermission === 'denied') {
                                notificationStatus = '❌ 通知被拒绝';
                            } else {
                                notificationStatus = '⚠️ 通知待授权';
                            }
                            
                            aiResponseContent += `\n\n✅ **提醒创建成功**\n📅 ${dateStr} ${timeStr}\n📝 ${parsed.content}\n⏰ ${delay > 0 ? delay + '分钟后提醒' : '时间已过'}\n🔔 ${notificationStatus}`;
                        } catch (error) {
                            console.error('创建提醒失败:', error);
                            aiResponseContent += `\n\n❌ 提醒创建失败：${error.message}`;
                        }
                    }
                }
                
                const aiMessage = { role: 'assistant', content: aiResponseContent, id: Date.now() + 1 };
                
                if (loadingDiv && loadingDiv.parentNode === chatHistoryContainer) {
                    chatHistoryContainer.removeChild(loadingDiv);
                }
                // Use typewriter effect for AI responses
                addMessageToChat(aiMessage.content, false, aiMessage.id, true);
                currentSession.messages.push(aiMessage);
                saveSessions();

            } catch (error) {
                console.error('API call error:', error);
                if (loadingDiv.parentNode) chatHistoryContainer.removeChild(loadingDiv);
                addMessageToChat('抱歉，服务暂时不可用，请稍后再试。', false);
            } finally {
                isLoading = false;
                askButton.disabled = false;
            }
        }

        function clearAllHistory() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                    <p class="mb-4">确定要清除所有对话历史吗？此操作不可撤销。</p>
                    <button id="confirmClear" class="bg-red-600 text-white px-4 py-2 rounded mr-2 hover:bg-red-700">确定</button>
                    <button id="cancelClear" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">取消</button>
                </div>`;
            document.body.appendChild(modal);
            document.getElementById('confirmClear').onclick = () => {
                sessions = [];
                activeSessionId = null;
                localStorage.removeItem('secretaryAiSessions');
                showNewChatScreen();
                document.body.removeChild(modal);
            };
            document.getElementById('cancelClear').onclick = () => {
                document.body.removeChild(modal);
            };
        }

        // --- CONTEXT MENU FUNCTIONS ---
        function showContextMenu(e) {
            e.preventDefault();
            const messageEl = e.target.closest('.chat-message');
            if (!messageEl) return;

            const messageId = messageEl.dataset.messageId;
            contextMenu.dataset.targetMessageId = messageId;
            
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.classList.remove('hidden');
        }

        function hideContextMenu() {
            contextMenu.classList.add('hidden');
        }

        function deleteMessageHandler() {
            const messageId = contextMenu.dataset.targetMessageId;
            if (!messageId) return;

            const session = sessions.find(s => s.id === activeSessionId);
            if (!session) return;

            session.messages = session.messages.filter(m => m.id != messageId);
            saveSessions();

            const messageEl = document.querySelector(`[data-message-id='${messageId}']`);
            if (messageEl) {
                messageEl.remove();
            }
            hideContextMenu();
        }

        // --- CALENDAR FUNCTIONS ---
        function openCalendar() {
            const calendarModal = document.getElementById('calendarModal');
            if (calendarModal) {
                calendarModal.style.display = 'block';
                currentCalendarDate = new Date();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('modalEventDate').value = today;
                generateCalendar();
                loadModalEvents();
            }
        }

        function closeCalendar() {
            document.getElementById('calendarModal').style.display = 'none';
        }

        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            generateCalendar();
        }

        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            const calendarHeader = document.getElementById('calendarHeader');
            if (!calendar || !calendarHeader) return;
            
            const selectedDateStr = document.getElementById('modalEventDate').value;
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            calendarHeader.textContent = `${year}年 ${month + 1}月`;
            calendar.innerHTML = '';
            
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day font-semibold text-center bg-gray-100 !cursor-default';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDayOfMonth.getDay();

            const allEvents = JSON.parse(localStorage.getItem('secretaryEvents') || '[]');

            for (let i = 0; i < firstDayOfWeek; i++) {
                calendar.appendChild(document.createElement('div')).className = 'calendar-day !cursor-default';
            }

            for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day flex flex-col items-center justify-start p-1';
                dayDiv.dataset.date = dateStr;
                
                const dayNumber = document.createElement('span');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayDiv.appendChild(dayNumber);

                if (allEvents.some(event => event.date === dateStr)) {
                    dayDiv.classList.add('has-event');
                }
                if (dateStr === selectedDateStr) {
                    dayDiv.classList.add('selected');
                }

                dayDiv.onclick = () => {
                    document.getElementById('modalEventDate').value = dateStr;
                    document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
                    dayDiv.classList.add('selected');
                    loadModalEvents();
                };
                
                calendar.appendChild(dayDiv);
            }
        }

        function addModalEvent() {
            const dateInput = document.getElementById('modalEventDate');
            const timeInput = document.getElementById('modalEventTime');
            const textInput = document.getElementById('modalEventText');
            
            const date = dateInput.value;
            const text = textInput.value.trim();
            const time = timeInput.value;
            
            if (!date || !text) {
                alert('请填写完整的日期和事件内容');
                return;
            }
            
            let events = JSON.parse(localStorage.getItem('secretaryEvents') || '[]');
            events.push({ id: Date.now(), date, time, text, type: 'manual' });
            localStorage.setItem('secretaryEvents', JSON.stringify(events));
            
            textInput.value = '';
            timeInput.value = '';
            
            generateCalendar();
            loadModalEvents();
        }

        function loadModalEvents() {
            const eventsList = document.getElementById('modalEventsList');
            const selectedDate = document.getElementById('modalEventDate').value;
            if (!eventsList || !selectedDate) return;
            
            const allEvents = JSON.parse(localStorage.getItem('secretaryEvents') || '[]');
            const dayEvents = allEvents
                .filter(event => event.date === selectedDate)
                .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
            
            if (dayEvents.length === 0) {
                eventsList.innerHTML = '<div class="text-gray-500 text-center py-4">当天没有事件</div>';
                return;
            }
            
            eventsList.innerHTML = dayEvents.map(event => {
                const typeIcon = event.type === 'reminder' ? '⏰' : '📅';
                const typeLabel = event.type === 'reminder' ? '智能提醒' : '手动事件';
                return `
                    <div class="flex justify-between items-center p-2 border-b">
                        <div>
                            <div class="font-semibold">${typeIcon} ${event.time ? event.time : '全天'}</div>
                            <div class="text-sm text-gray-600">${event.text}</div>
                            <div class="text-xs text-blue-500">${typeLabel}</div>
                        </div>
                        <button onclick="deleteModalEvent(${event.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">删除</button>
                    </div>
                `;
            }).join('');
        }

        function deleteModalEvent(id) {
            let events = JSON.parse(localStorage.getItem('secretaryEvents') || '[]');
            events = events.filter(event => event.id !== id);
            localStorage.setItem('secretaryEvents', JSON.stringify(events));
            generateCalendar();
            loadModalEvents();
        }

        // --- REMINDER SYSTEM ---
        class SimpleTimeParser {
            static parseFixedFormat(text) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                // 固定格式：日期 时间 内容
                // 支持格式：今天/明天/后天 HH:MM 内容 或 MM-DD HH:MM 内容 或 YYYY-MM-DD HH:MM 内容
                const patterns = [
                    // 相对日期格式：今天/明天/后天 HH:MM 内容
                    /^(今天|明天|后天)\s+(\d{1,2}):(\d{2})\s+(.+)$/,
                    // 月日格式：MM-DD HH:MM 内容
                    /^(\d{1,2})-(\d{1,2})\s+(\d{1,2}):(\d{2})\s+(.+)$/,
                    // 完整日期格式：YYYY-MM-DD HH:MM 内容
                    /^(\d{4})-(\d{1,2})-(\d{1,2})\s+(\d{1,2}):(\d{2})\s+(.+)$/
                ];
                
                for (let i = 0; i < patterns.length; i++) {
                    const match = text.trim().match(patterns[i]);
                    if (match) {
                        let targetDate = new Date(today);
                        let hour, minute, content;
                        
                        if (i === 0) {
                            // 相对日期格式
                            const [, dateKeyword, h, m, c] = match;
                            hour = parseInt(h);
                            minute = parseInt(m);
                            content = c;
                            
                            switch (dateKeyword) {
                                case '明天':
                                    targetDate.setDate(targetDate.getDate() + 1);
                                    break;
                                case '后天':
                                    targetDate.setDate(targetDate.getDate() + 2);
                                    break;
                                // '今天' 保持不变
                            }
                        } else if (i === 1) {
                            // 月日格式
                            const [, month, day, h, m, c] = match;
                            const targetMonth = parseInt(month) - 1;
                            const targetDay = parseInt(day);
                            hour = parseInt(h);
                            minute = parseInt(m);
                            content = c;
                            
                            targetDate = new Date(now.getFullYear(), targetMonth, targetDay);
                            // 如果日期已过，设为明年
                            if (targetDate < today) {
                                targetDate.setFullYear(targetDate.getFullYear() + 1);
                            }
                        } else {
                            // 完整日期格式
                            const [, year, month, day, h, m, c] = match;
                            hour = parseInt(h);
                            minute = parseInt(m);
                            content = c;
                            
                            targetDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        }
                        
                        // 验证时间格式
                        if (hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                            continue;
                        }
                        
                        const finalDateTime = new Date(targetDate);
                        finalDateTime.setHours(hour, minute, 0, 0);
                        
                        // 检查时间是否有效（未来时间）
                        if (finalDateTime > now) {
                            return {
                                dateTime: finalDateTime,
                                content: content.trim(),
                                isValid: true
                            };
                        }
                    }
                }
                
                return {
                    dateTime: null,
                    content: '',
                    isValid: false
                };
            }
        }
        
        class ReminderManager {
            static createReminder(content, dateTime) {
                const reminder = {
                    id: Date.now(),
                    date: dateTime.toISOString().split('T')[0],
                    time: dateTime.toTimeString().slice(0, 5),
                    text: content,
                    type: 'reminder',
                    notified: false,
                    source: 'ai_reminder',
                    dateTime: dateTime.getTime()
                };
                
                // 保存到日历事件
                let events = JSON.parse(localStorage.getItem('secretaryEvents') || '[]');
                events.push(reminder);
                localStorage.setItem('secretaryEvents', JSON.stringify(events));
                
                // 设置通知
                NotificationService.scheduleNotification(reminder);
                
                return reminder;
            }
            
            static checkPendingReminders() {
                const now = new Date().getTime();
                const events = JSON.parse(localStorage.getItem('secretaryEvents') || '[]');
                
                events.forEach(event => {
                    if (event.type === 'reminder' && !event.notified && event.dateTime <= now) {
                        NotificationService.showNotification(event.text, {
                            body: `提醒时间：${event.date} ${event.time}`,
                            icon: '/favicon.ico',
                            tag: `reminder-${event.id}`
                        });
                        
                        // 标记为已通知
                        event.notified = true;
                        localStorage.setItem('secretaryEvents', JSON.stringify(events));
                    }
                });
            }
        }
        
        class NotificationService {
            static async requestPermission() {
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    return permission === 'granted';
                }
                return false;
            }
            
            static showNotification(title, options = {}) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    return new Notification(title, {
                        body: options.body || '',
                        icon: options.icon || '/favicon.ico',
                        tag: options.tag || 'reminder',
                        requireInteraction: true,
                        ...options
                    });
                }
            }
            
            static scheduleNotification(reminder) {
                const now = new Date().getTime();
                const delay = reminder.dateTime - now;
                
                if (delay > 0) {
                    setTimeout(() => {
                        this.showNotification(reminder.text, {
                            body: `提醒时间：${reminder.date} ${reminder.time}`,
                            icon: '/favicon.ico',
                            tag: `reminder-${reminder.id}`
                        });
                    }, delay);
                }
            }
        }
        
        // 初始化通知权限和提醒检查
        async function initializeReminderSystem() {
            console.log('初始化提醒系统...');
            
            // 请求通知权限
            const permission = await NotificationService.requestPermission();
            console.log('通知权限状态:', Notification.permission);
            
            // 如果权限被拒绝，显示提示
            if (Notification.permission === 'denied') {
                console.warn('通知权限被拒绝，提醒功能将无法正常工作');
            }
            
            // 定期检查提醒
            setInterval(() => {
                ReminderManager.checkPendingReminders();
            }, 30000); // 每30秒检查一次，更频繁
            
            // 立即检查一次
            ReminderManager.checkPendingReminders();
        }
        
        // 页面加载完成后初始化
        initializeReminderSystem();
        
        // --- MODE MANAGEMENT ---
        // Mode management is handled in setMode() and loadChat() functions

        // --- INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            // Chat Listeners
            askButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            newChatBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showNewChatScreen();
            });
            clearHistoryBtn.addEventListener('click', (e) => {
                e.preventDefault();
                clearAllHistory();
            });

            // Context Menu Listeners
            chatHistoryContainer.addEventListener('contextmenu', showContextMenu);
            window.addEventListener('click', hideContextMenu);

            // Sidebar Collapse Listeners
            sidebarToggleBtn.addEventListener('click', () => {
                const isHidden = sidebar.classList.toggle('hidden');
                localStorage.setItem('sidebarCollapsed', isHidden);
            });

            collapseHistoryBtn.addEventListener('click', () => {
                const isHidden = chatHistoryList.classList.toggle('hidden');
                collapseHistoryBtn.querySelector('svg').style.transform = isHidden ? 'rotate(-90deg)' : 'rotate(0deg)';
                localStorage.setItem('isHistoryCollapsed', isHidden);
            });

            // Calendar Listeners
            calendarButton.addEventListener('click', (e) => {
                e.preventDefault();
                openCalendar();
            });
            window.addEventListener('click', (e) => {
                const modal = document.getElementById('calendarModal');
                if (e.target === modal) closeCalendar();
            });

            // Initial Load
            loadSessions();
            renderChatList();
            showNewChatScreen();

            // Restore sidebar collapsed state
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                sidebar.classList.add('hidden');
            }

            // Restore history list collapsed state
            const isHistoryCollapsed = localStorage.getItem('isHistoryCollapsed') === 'true';
            chatHistoryList.classList.toggle('hidden', isHistoryCollapsed);
            collapseHistoryBtn.querySelector('svg').style.transform = isHistoryCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
        });
    </script>
</body>
</html>
